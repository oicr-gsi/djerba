---
title: "extract_onco.R"
author: "Lauren Toy Dec 2022"
output: html_document
---  
***
#### **Packages**
```{r}
library(ggplot2)
library(data.table)
library(forcats) # within tidyverse
```  
***
#### **Oncoplot**
* main plot using geom_rect so background panel gridlines align with coloured boxes
* 2 input CSV's w/ Study, TMB, and Gene/Mutation(s) from small_mutations_and_indels and oncogenic_somatic_CNVs
* these CSV's are the output of a multi query (design.py & pull.py)

```{r}
small_file = '/home/ltoy/Desktop/couch/extract/oncoplot/small_Study&Body&Tumour Mutation Burden_processed.csv'
small <- fread(small_file, header=TRUE)
onco_file = '/home/ltoy/Desktop/couch/extract/oncoplot/onco_Study&Body&Tumour Mutation Burden_processed.csv'
onco <- fread(onco_file, header=TRUE)
small$Field <- 'small_mutations_and_indels'
onco$Field <- 'oncogenic_somatic_CNVs'
colnames(small)[3] = "Mutation"
colnames(onco)[3] ="Mutation"
colnames(small)[1]="id"
colnames(onco)[1]="id"
combined <- rbind(small, onco)
gene_order<-data.frame(table(combined$Gene))
gene_order <- gene_order[order(-gene_order$Freq),]
cutoff = 3 # varies # of genes on y-axis
# Note: if want a set number, then change code to count top n rows from gene_order
subset = sum(gene_order$Freq>cutoff)
gene_subset <- gene_order[1:subset,]
gene_list = as.character(gene_subset$Var1)

header <- c("id", "Gene", "Mutation", "Study", "Field", "TMB")
newdf <- data.frame(matrix(NA, nrow=0, ncol=length(header)))
colnames(newdf) <- header
count = 0
for (row in 1:nrow(combined)){
  check_gene = as.character(combined[row, "Gene"])
  if(check_gene %in% gene_list){
    id = as.character(combined[row, "id"])
    gene = as.character(combined[row, "Gene"])
    mutation = as.character(combined[row, "Mutation"])
    study = as.character(combined[row, "Study"])
    field = as.character(combined[row, "Field"])
    tmb = as.character(combined[row, "TMB"])
    adddf <- data.frame(matrix(NA, nrow=1, ncol=length(header)))
    colnames(adddf) <- header
    adddf[nrow(adddf) == 1] <- list(id, gene, mutation, study, field, tmb)
    newdf <- rbind(newdf, adddf)
    count = count +1
  }
}

#for geom_rect arguments of indexing border of each box
id.num = as.numeric(as.factor(newdf$id))
gene.num = as.numeric(as.factor(fct_rev(fct_infreq(newdf$Gene))))
id.key <- levels(factor(newdf$id))
gene.key <- levels(fct_rev(fct_infreq(newdf$Gene)))
report_number = length(table(newdf$id))
onco_title = paste("Top", nrow(gene_subset), "Mutated Genes in", report_number, "Samples")

#percents on right hand side of y axis
gene_subset$Percent <- NA
total_mutations = sum(gene_subset$Freq)
for (row in 1:nrow(gene_subset)){
  frequency = gene_subset[row, "Freq"]
  percent = (frequency/total_mutations * 100)
  percent = format(round(percent, 1), nsmall=1)
  percent = paste(percent,"%")
  gene_subset[row, "Percent"] <- percent
}
percent.key <- gene_subset$Percent

o <-
ggplot(newdf) +
  geom_rect(aes(xmin=id.num, xmax=id.num+1, ymin=gene.num, ymax=gene.num+1,fill=Mutation),color="white")+
  scale_x_continuous(breaks=seq(1.5, length(id.key)+0.5,1), labels=id.key, expand=c(0,0))+
  scale_y_continuous(breaks=seq(1.5, length(gene.key)+0.5,1), labels=gene.key, expand=c(0,0),
                     sec.axis = (sec_axis(trans=~.,breaks=seq(1.5, length(gene.key)+0.5,1),
                                          labels=rev(percent.key))))+
  labs(title = onco_title) + 
  theme(
    plot.title=element_blank(), #blank if combine tmb and main below
    #plot.title = element_text(size=8, hjust=0.5),
    axis.title.x=element_blank(), axis.title.y=element_blank(),
    axis.ticks.x=element_blank(),axis.ticks.y=element_blank(),
    axis.text.x=element_blank(),
    #axis.text.x=element_text(size=3, angle=90), #id
    axis.text.y=element_text(size=5, hjust=1),
    panel.grid.major = element_blank(),
    panel.grid.minor=element_line(color="white"),
    legend.position="bottom", 
    legend.title=element_blank(),
    legend.box.margin = margin(t=-10, b=0, l=-50, r=0),
    legend.key.size= unit(3, 'mm'),
    legend.text=element_text(size=5, hjust=0),
    strip.text = element_text(size=3),
  )+
  scale_fill_manual(values=c("saddlebrown","lightgoldenrod3", "forestgreen", "hotpink", "purple","cyan",
                             "gold", "royalblue", "orange", "black", "firebrick1", "chartreuse"))+
  guides(fill = guide_legend(nrow = 2))
```

```{r fig.align="center"}
o + theme(aspect.ratio=1/1.5)
```

```{r fig.align="center", fig.dim=c(9,5)}
o + facet_grid(.~Study, scales="free_x", space="free_x") # subset by Study in x dir
```  

***
#### **Frequency**
* right bar graph 
```{r}
freq <- 
ggplot(newdf)+
  geom_bar(aes(y=fct_rev(fct_infreq(Gene)), fill=Mutation))+
  labs(x="No. of Mutations")+
  theme_classic()+
  theme(
    axis.text.x = element_text(size=10),
    axis.text.y = element_blank(),
    axis.ticks.length = unit(4, "mm"),
    axis.ticks.y=element_blank(),
    axis.line.y = element_blank(),
    axis.title.x = element_text(size=10, hjust=0.5),
    axis.title.y=element_blank(),
    legend.position = "None"
  )+
  scale_fill_manual(values=c("saddlebrown","lightgoldenrod3", "forestgreen", "hotpink", "purple","cyan",
                               "gold", "royalblue", "orange", "black", "firebrick1", "chartreuse"))+
  scale_x_continuous(breaks=c(0,70), limits=c(0,70), expand=c(0,0), position="top")
```  

```{r}
freq
```

***
#### **TMB**
* top bar graph
```{r}
library(cowplot) #get_legend()
id.key.df <- as.data.frame(levels(factor(newdf$id)))
id.key.df$TMB <-NA
id.key.df$Study <-NA
id.key.df$Field <-NA
colnames(id.key.df) <- c("id", "TMB", "Study", "Field")
for (id in id.key){
  extract_row <- newdf[newdf$id == id,]
  extract_tmb = as.numeric(extract_row[1,"TMB"])
  if (extract_tmb > 100) { extract_tmb = 100 }
  extract_study = as.character(extract_row[1,"Study"])
  extract_field = as.character(extract_row[1,"Field"])
  extract_add <- list(extract_tmb, extract_study, extract_field)
  for(row in 1:nrow(id.key.df)){
    unique_id = as.character(id.key.df[row, "id"])
    if(id == unique_id){
      id.key.df[row,] <- list(unique_id, extract_tmb, extract_study, extract_field)
    }
  }
}

tmb <-
ggplot(id.key.df, aes(x=id, y=TMB, fill=Study))+
  geom_bar(position='dodge', stat='identity', aes(group=Study))+
  theme_classic()+
  labs(title=onco_title)+
  theme(
    plot.title = element_blank(),
    #legend.position="none", # if combined separately below
    legend.position = "top",
    axis.text.x = element_blank(),
    #axis.text.x = element_text(size=5, angle=90), #id
    axis.text.y=element_text(size=7),
    axis.ticks.length.y = unit(3, "mm"),
    axis.title.x=element_blank(), axis.title.y=element_text(size=8),
    axis.line.x = element_blank(), axis.ticks.x = element_blank(),
    legend.key.size = unit(5, "mm"),
    legend.title = element_blank(),
    strip.text.x=element_blank(),
  )+
  guides(fill = guide_legend(ncol=6))+
  scale_fill_manual(values=c("PASS01"= "deepskyblue3", "CYPRESS"="indianred2", "HPB"="goldenrod", 
                             "PANXWGTS"="cyan3",  "LBR"="chartreuse4", "VENUS"="darkorchid2"))+
  scale_y_continuous(breaks=c(0,25,50,75,100),labels=c(0,25,50,75,'>100'), limits=c(0,100), expand=c(0,0))

legend <- get_legend(tmb) #saved as gtable
```  

```{r fig.align="center", fig.dim=c(9,3)}
tmb + theme(legend.position="none")
```

```{r fig.align="center", fig.dim=c(10,2.75)}
tmb + facet_grid(.~Study, scales="free_x", space="free_x", switch="x") # subset by Study in x dir
```  

***
#### **Combine**
Note: likely easier or same amount of time to do outside of R than method below as last step requires lots of adjusting 

* Combine main oncoplot, frequency and tmb bar graph, and TMB legend
```{r fig.align="center", warning=FALSE}
library(cowplot)
library(gtable)
library(grid)

o_ratio <- o +theme(aspect.ratio=1/1.5)
tmb_nolegend <- tmb + theme(legend.key.size=unit(3,"mm"), legend.text=element_text(size=5), 
                            aspect.ratio=2/10,
                            plot.title=element_text(size=9, hjust=0.5),
                            axis.ticks.length.y = unit(2, "mm"),
                            axis.title.y=element_text(size=6))
freq_resized <- freq + theme(axis.title.x = element_text(size=7), axis.ticks.length=unit(2, "mm"),
                             axis.text.x = element_text(size=7))

top <- ggplotGrob(tmb_nolegend)
main <- ggplotGrob(o_ratio)
right <- ggplotGrob(freq_resized)
vert_comb <- rbind(top, main, size="first")
vert_comb$widths <- unit.pmax(top$widths, main$widths)

ggdraw()+
  draw_plot(right, x = 0.77, y=0.08675, width=0.21, height=0.663)+
  draw_plot(vert_comb, x= -0.1, y=0.0) 
```  

* x, y, width, and height values are very sensitive and very specifically need to be adjusted
* found aligning outside of R easier/faster (i.e. used figma and could make space between main and top bar graph less)
